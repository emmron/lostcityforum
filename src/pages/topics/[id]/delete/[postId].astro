---
import MainLayout from "../../../../layouts/MainLayout.astro";
import { db } from "../../../../lib/db.js";

export const prerender = false;

const { id, postId } = Astro.params;

// Check if user is logged in
const isLoggedIn = Astro.cookies.has('user_id');
if (!isLoggedIn) {
  return Astro.redirect(`/login?returnUrl=${encodeURIComponent(Astro.url.pathname)}`);
}

const userId = Number(Astro.cookies.get('user_id').value);
const currentUser = await db.user.findById(userId);

// Fetch the post
const post = await db.post.getById(Number(postId));

if (!post) {
  return Astro.redirect(`/topics/${id}`);
}

// Check authorization - only post author or Admin can delete
const isAuthor = currentUser?.id === post.authorId;
const isAdmin = currentUser?.username === "Admin";

if (!isAuthor && !isAdmin) {
  return Astro.redirect(`/topics/${id}`);
}

// Fetch topic data
const topic = await db.topic.getById(Number(id));

if (!topic) {
  return Astro.redirect('/forums');
}

// Check if this is the first post (cannot delete it - would delete the topic)
const isFirstPost = topic.posts && topic.posts.length > 0 && topic.posts[0].id === Number(postId);

let errorMessage = '';

// Handle form submission
if (Astro.request.method === 'POST') {
  try {
    const data = await Astro.request.formData();
    const confirmDelete = data.get('confirm')?.toString();

    if (confirmDelete === 'yes') {
      if (isFirstPost) {
        errorMessage = 'Cannot delete the first post of a topic. Delete the entire topic instead.';
      } else {
        // Delete the post
        await db.post.delete(Number(postId));

        // Redirect back to the topic
        return Astro.redirect(`/topics/${id}`);
      }
    } else {
      // User cancelled - redirect back
      return Astro.redirect(`/topics/${id}#post-${postId}`);
    }
  } catch (error) {
    console.error('Error deleting post:', error);
    errorMessage = 'An error occurred while deleting the post. Please try again.';
  }
}
---

<MainLayout title={`Delete Post - ${topic.title}`}>
  <div class="breadcrumbs">
    <a href="/">Home</a> &raquo;
    <a href="/forums">Forums</a> &raquo;
    <a href={`/forums/${topic.forum.id}`}>{topic.forum.title}</a> &raquo;
    <a href={`/topics/${id}`}>{topic.title}</a> &raquo;
    Delete Post
  </div>

  <div class="delete-post">
    <h1>Delete Post</h1>

    {errorMessage && (
      <div class="alert alert-error">
        {errorMessage}
      </div>
    )}

    {isFirstPost ? (
      <div class="alert alert-warning">
        <p><strong>Cannot delete this post.</strong></p>
        <p>This is the first post of the topic. Deleting it would remove the entire topic. If you want to delete the topic, please contact an administrator.</p>
        <div class="form-actions">
          <a href={`/topics/${id}`} class="btn btn-primary">Go Back</a>
        </div>
      </div>
    ) : (
      <>
        <div class="warning-box">
          <h3>Are you sure you want to delete this post?</h3>
          <p>This action cannot be undone.</p>
        </div>

        <div class="post-preview">
          <div class="post-header">
            <span>Posted by <strong>{post.author?.username || 'Unknown'}</strong> on {new Date(post.createdAt).toLocaleString()}</span>
          </div>
          <div class="post-content" set:html={post.content} />
        </div>

        <form method="POST" class="delete-form">
          <div class="form-actions">
            <button type="submit" name="confirm" value="yes" class="btn btn-danger">Yes, Delete This Post</button>
            <button type="submit" name="confirm" value="no" class="btn">Cancel</button>
          </div>
        </form>
      </>
    )}
  </div>

  <style>
    .delete-post {
      background-color: var(--forum-topic-bg);
      padding: 20px;
      border: 1px solid var(--border-color);
      margin-bottom: 20px;
      max-width: 800px;
    }

    .delete-post h1 {
      color: var(--secondary-color);
      margin-bottom: 20px;
      font-size: 24px;
    }

    .warning-box {
      background-color: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .warning-box h3 {
      color: #856404;
      margin: 0 0 10px 0;
    }

    .warning-box p {
      color: #856404;
      margin: 0;
    }

    .post-preview {
      background-color: var(--forum-topic-alt);
      border: 1px solid var(--border-color);
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .post-header {
      background-color: var(--post-header);
      padding: 10px 15px;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
    }

    .post-content {
      padding: 15px;
      line-height: 1.6;
    }

    .delete-form {
      margin-top: 20px;
    }

    .form-actions {
      display: flex;
      gap: 10px;
    }

    .btn-danger {
      background-color: #dc3545;
      border-color: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background-color: #c82333;
      border-color: #bd2130;
    }

    .alert {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .alert-error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .alert-warning {
      background-color: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
    }

    .alert-warning p {
      margin: 5px 0;
    }

    .alert-warning .form-actions {
      margin-top: 15px;
    }
  </style>
</MainLayout>
