---
import MainLayout from "../../layouts/MainLayout.astro";
import { db } from "../../lib/db.js";

export const prerender = false;

// Check if user is logged in
const isLoggedIn = Astro.cookies.has('user_id');
if (!isLoggedIn) {
  return Astro.redirect('/login?returnUrl=/account/edit');
}

const userId = Number(Astro.cookies.get('user_id').value);
const user = await db.user.findById(userId);

if (!user) {
  return Astro.redirect('/login');
}

let errorMessage = '';
let successMessage = '';
let formData = {
  signature: user.signature || '',
  avatarUrl: user.avatarUrl || ''
};

// Handle form submission
if (Astro.request.method === 'POST') {
  try {
    const data = await Astro.request.formData();
    const action = data.get('action')?.toString();

    if (action === 'update_profile') {
      const signature = data.get('signature')?.toString() || '';
      const avatarUrl = data.get('avatarUrl')?.toString() || '';

      formData = { signature, avatarUrl };

      // Validate signature length
      if (signature.length > 500) {
        errorMessage = 'Signature must be 500 characters or less';
      } else {
        // Update profile
        await db.user.updateProfile(userId, { signature, avatarUrl });
        successMessage = 'Profile updated successfully!';
        formData = { signature, avatarUrl };
      }
    } else if (action === 'change_password') {
      const currentPassword = data.get('current_password')?.toString() || '';
      const newPassword = data.get('new_password')?.toString() || '';
      const confirmPassword = data.get('confirm_password')?.toString() || '';

      // Validate current password
      const isValidPassword = await db.user.verifyPassword(user, currentPassword);
      if (!isValidPassword) {
        errorMessage = 'Current password is incorrect';
      } else if (newPassword.length < 6) {
        errorMessage = 'New password must be at least 6 characters long';
      } else if (newPassword !== confirmPassword) {
        errorMessage = 'New passwords do not match';
      } else {
        // Update password
        await db.user.changePassword(userId, newPassword);
        successMessage = 'Password changed successfully!';
      }
    }
  } catch (error) {
    console.error('Error updating profile:', error);
    errorMessage = 'An error occurred. Please try again.';
  }
}
---

<MainLayout title="Edit Profile">
  <div class="breadcrumbs">
    <a href="/">Home</a> &raquo;
    <a href={`/members/${user.username}`}>My Profile</a> &raquo;
    Edit Profile
  </div>

  <div class="edit-profile">
    <h1>Edit Profile</h1>

    {errorMessage && (
      <div class="alert alert-error">
        {errorMessage}
      </div>
    )}

    {successMessage && (
      <div class="alert alert-success">
        {successMessage}
      </div>
    )}

    <div class="profile-sections">
      <!-- Profile Settings Section -->
      <section class="profile-section">
        <h2>Profile Settings</h2>
        <form method="POST" class="edit-form">
          <input type="hidden" name="action" value="update_profile" />

          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" value={user.username} class="form-control" disabled>
            <small class="form-help">Username cannot be changed</small>
          </div>

          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" value={user.email} class="form-control" disabled>
            <small class="form-help">Contact an administrator to change your email</small>
          </div>

          <div class="form-group">
            <label for="avatarUrl">Avatar URL</label>
            <input type="url" id="avatarUrl" name="avatarUrl" value={formData.avatarUrl} class="form-control" placeholder="https://example.com/avatar.png">
            <small class="form-help">Enter a URL to an image (recommended size: 100x100 pixels)</small>
          </div>

          <div class="form-group">
            <label for="signature">Signature</label>
            <textarea id="signature" name="signature" class="form-control" rows="4" maxlength="500">{formData.signature}</textarea>
            <small class="form-help">Maximum 500 characters. Will be shown below your posts.</small>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Profile</button>
            <a href={`/members/${user.username}`} class="btn">Cancel</a>
          </div>
        </form>
      </section>

      <!-- Password Change Section -->
      <section class="profile-section">
        <h2>Change Password</h2>
        <form method="POST" class="edit-form">
          <input type="hidden" name="action" value="change_password" />

          <div class="form-group">
            <label for="current_password">Current Password</label>
            <input type="password" id="current_password" name="current_password" class="form-control" required>
          </div>

          <div class="form-group">
            <label for="new_password">New Password</label>
            <input type="password" id="new_password" name="new_password" class="form-control" required minlength="6">
            <small class="form-help">Minimum 6 characters</small>
          </div>

          <div class="form-group">
            <label for="confirm_password">Confirm New Password</label>
            <input type="password" id="confirm_password" name="confirm_password" class="form-control" required>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Change Password</button>
          </div>
        </form>
      </section>

      <!-- Account Info Section -->
      <section class="profile-section info-section">
        <h2>Account Information</h2>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Member Since:</span>
            <span class="info-value">{new Date(user.createdAt).toLocaleDateString()}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Total Posts:</span>
            <span class="info-value">{user.postsCount}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Last Updated:</span>
            <span class="info-value">{new Date(user.updatedAt).toLocaleDateString()}</span>
          </div>
        </div>
      </section>
    </div>
  </div>

  <style>
    .edit-profile {
      max-width: 800px;
      margin: 0 auto;
    }

    .edit-profile h1 {
      color: var(--secondary-color);
      margin-bottom: 20px;
    }

    .profile-sections {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .profile-section {
      background-color: var(--forum-topic-bg);
      padding: 20px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
    }

    .profile-section h2 {
      color: var(--secondary-color);
      font-size: 18px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .edit-form {
      max-width: 100%;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-control {
      width: 100%;
      padding: 10px;
      background-color: var(--input-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      border-radius: 3px;
    }

    .form-control:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .form-help {
      display: block;
      margin-top: 5px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .form-actions {
      display: flex;
      gap: 10px;
    }

    .info-section {
      background-color: var(--forum-topic-alt);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
    }

    .info-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 3px;
    }

    .info-value {
      font-weight: bold;
    }

    .alert {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .alert-error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .alert-success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
  </style>
</MainLayout>
