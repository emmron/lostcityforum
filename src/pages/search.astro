---
import MainLayout from "../layouts/MainLayout.astro";
import { db } from "../lib/db.js";

export const prerender = false;

// Get search parameters from URL
const q = Astro.url.searchParams.get('q') || '';
const forum = Astro.url.searchParams.get('forum') || '';
const author = Astro.url.searchParams.get('author') || '';
const date = Astro.url.searchParams.get('date') || '';
const searchTitles = Astro.url.searchParams.get('search_titles') !== '0';
const searchPosts = Astro.url.searchParams.get('search_posts') !== '0';

// Get all forums for the filter dropdown
const forums = await db.forum.getAll();

// Perform search if there's a query
let searchResults = [];
let totalResults = 0;

if (q && q.length >= 2) {
  try {
    const results = await db.search.query({
      q,
      forumId: forum || null,
      author: author || null,
      dateRange: date || null,
      searchTitles,
      searchPosts
    });

    // Combine topics and posts into single results array
    searchResults = [...results.topics, ...results.posts];

    // Sort by date (newest first)
    searchResults.sort((a, b) => new Date(b.date) - new Date(a.date));

    totalResults = searchResults.length;
  } catch (error) {
    console.error('Search error:', error);
  }
}
---

<MainLayout title="Search">
  <div class="breadcrumbs">
    <a href="/">Home</a> &raquo; Search
  </div>

  <h1>Search the Forum</h1>

  <form class="search-form" action="/search" method="get">
    <div class="form-group">
      <label for="q" class="form-label">Search Terms</label>
      <input type="text" id="q" name="q" class="form-control" value={q} required minlength="2">
      <small class="form-help">Minimum 2 characters required</small>
    </div>

    <div class="advanced-search">
      <div class="form-group">
        <label for="forum" class="form-label">Forum</label>
        <select id="forum" name="forum" class="form-control">
          <option value="">All Forums</option>
          {forums.map(f => (
            <option value={f.id} selected={forum === String(f.id)}>{f.title}</option>
          ))}
        </select>
      </div>

      <div class="form-group">
        <label for="author" class="form-label">Author</label>
        <input type="text" id="author" name="author" class="form-control" value={author} placeholder="Username">
      </div>

      <div class="form-group">
        <label for="date" class="form-label">Date Range</label>
        <select id="date" name="date" class="form-control">
          <option value="" selected={!date}>Any Time</option>
          <option value="1" selected={date === "1"}>Today</option>
          <option value="7" selected={date === "7"}>Last Week</option>
          <option value="30" selected={date === "30"}>Last Month</option>
          <option value="90" selected={date === "90"}>Last 3 Months</option>
          <option value="365" selected={date === "365"}>Last Year</option>
        </select>
      </div>
    </div>

    <div class="form-group search-options">
      <div>
        <input type="checkbox" id="search_titles" name="search_titles" value="1" checked={searchTitles}>
        <label for="search_titles">Search Topic Titles</label>
      </div>
      <div>
        <input type="checkbox" id="search_posts" name="search_posts" value="1" checked={searchPosts}>
        <label for="search_posts">Search Post Content</label>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">Search</button>
      <a href="/search" class="btn">Reset</a>
    </div>
  </form>

  {q && q.length >= 2 && searchResults.length > 0 && (
    <div class="search-results">
      <h2>Search Results for "{q}"</h2>
      <p class="result-count">{totalResults} result{totalResults !== 1 ? 's' : ''} found</p>

      <div class="result-list">
        {searchResults.map((result) => (
          <div class="result-item">
            <div class="result-type">
              <span class={`type-badge ${result.type}`}>{result.type === 'topic' ? 'Topic' : 'Post'}</span>
            </div>
            <div class="result-title">
              {result.type === "topic" ? (
                <a href={`/topics/${result.id}`}>{result.title}</a>
              ) : (
                <a href={`/topics/${result.topic?.id}#post-${result.id}`}>Re: {result.topic?.title || 'Unknown Topic'}</a>
              )}
            </div>
            <div class="result-meta">
              <span>Posted by <strong>{result.author}</strong></span>
              {result.forum && (
                <span> in <a href={`/forums/${result.forum.id}`}>{result.forum.name}</a></span>
              )}
              <span> on {result.date}</span>
            </div>
            <div class="result-snippet" set:html={result.snippet} />
          </div>
        ))}
      </div>
    </div>
  )}

  {q && q.length >= 2 && searchResults.length === 0 && (
    <div class="no-results">
      <h3>No Results Found</h3>
      <p>No results found for "<strong>{q}</strong>".</p>
      <p>Try using different keywords or removing filters to broaden your search.</p>
    </div>
  )}

  {q && q.length < 2 && (
    <div class="no-results">
      <p>Please enter at least 2 characters to search.</p>
    </div>
  )}

  <style>
    h1 {
      color: var(--secondary-color);
      margin-bottom: 20px;
    }

    .search-form {
      background-color: var(--forum-topic-bg);
      padding: 20px;
      border: 1px solid var(--border-color);
      margin-bottom: 30px;
    }

    .form-help {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 5px;
      display: block;
    }

    .advanced-search {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .search-options {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }

    .form-actions {
      display: flex;
      gap: 10px;
    }

    .search-results h2 {
      color: var(--secondary-color);
      margin-bottom: 10px;
    }

    .result-count {
      color: #999;
      margin-bottom: 20px;
      font-style: italic;
    }

    .result-list {
      margin-bottom: 20px;
    }

    .result-item {
      padding: 15px;
      border: 1px solid var(--border-color);
      background-color: var(--forum-topic-bg);
      margin-bottom: 15px;
      position: relative;
    }

    .result-type {
      margin-bottom: 8px;
    }

    .type-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .type-badge.topic {
      background-color: var(--primary-color);
      color: white;
    }

    .type-badge.post {
      background-color: var(--secondary-color);
      color: white;
    }

    .result-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .result-title a {
      color: var(--link-color);
      text-decoration: none;
    }

    .result-title a:hover {
      text-decoration: underline;
    }

    .result-meta {
      font-size: 12px;
      color: #999;
      margin-bottom: 10px;
    }

    .result-meta a {
      color: #999;
      text-decoration: underline;
    }

    .result-snippet {
      font-size: 14px;
      line-height: 1.5;
    }

    :global(.highlight) {
      background-color: rgba(255, 204, 51, 0.3);
      padding: 0 2px;
      border-radius: 2px;
    }

    .no-results {
      background-color: var(--forum-topic-bg);
      padding: 20px;
      border: 1px solid var(--border-color);
      text-align: center;
    }

    .no-results h3 {
      color: var(--secondary-color);
      margin-bottom: 10px;
    }

    .no-results p {
      margin-bottom: 10px;
    }
  </style>
</MainLayout>
