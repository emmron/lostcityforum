---
import MainLayout from "../../layouts/MainLayout.astro";
import { db } from "../../lib/db.js";

// Set to server-rendering instead of static generation
export const prerender = false;

// The getStaticPaths function can be removed since we're using server-side rendering
// export async function getStaticPaths() {
//   const forums = await db.forum.getAll();
//   return forums.map(forum => ({
//     params: { id: forum.id.toString() },
//     props: { forumId: forum.id }
//   }));
// }

// Get the forum ID from the params
const { id } = Astro.params;
const forumId = Number(id);

// Make sure forumId is a valid number
if (isNaN(forumId) || forumId <= 0) {
  return Astro.redirect('/forums');
}

// Fetch forum data from database
const forum = await db.forum.getById(forumId);

// If the forum doesn't exist, show an error
if (!forum) {
  return Astro.redirect('/404');
}

// Extract topics from the forum data
const topics = forum.topics || [];
---

<MainLayout title={forum.title}>
  <div class="breadcrumbs">
    <a href="/">Home</a> &raquo; <a href="/forums">Forums</a> &raquo; {forum.title}
  </div>

  <div class="forum-header">
    <h1>{forum.title}</h1>
    <a href={`/topics/create?forum=${forumId}`} class="btn btn-primary">New Topic</a>
  </div>

  {topics.length > 0 ? (
    <table class="topics-list">
      <thead>
        <tr>
          <th>Topic</th>
          <th>Author</th>
          <th>Replies</th>
          <th>Views</th>
          <th>Last Post</th>
        </tr>
      </thead>
      <tbody>
        {topics.map((topic) => {
          // Get the last post information
          const lastPost = topic.posts[0] || null;

          return (
            <tr class={topic.isSticky ? "sticky-topic" : ""}>
              <td class="topic-title">
                {topic.isSticky && <span class="topic-sticky">Sticky: </span>}
                {topic.isLocked && <span class="topic-locked">Locked: </span>}
                <a href={`/topics/${topic.id}`}>{topic.title}</a>
              </td>
              <td>{topic.author.username}</td>
              <td>{topic.posts.length > 0 ? topic.posts.length - 1 : 0}</td>
              <td>{topic.views}</td>
              <td>
                {lastPost && (
                  <>
                    <div>{new Date(lastPost.createdAt).toLocaleString()}</div>
                    <div>by {lastPost.author.username}</div>
                  </>
                )}
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>
  ) : (
    <div class="no-topics">
      <p>There are no topics in this forum yet.</p>
      <p>
        <a href={`/topics/create?forum=${forumId}`} class="btn">Create the first topic</a>
      </p>
    </div>
  )}

  <div class="forum-footer">
    <div class="paginator">
      <a href="#" class="current">1</a>
    </div>
    <a href={`/topics/create?forum=${forumId}`} class="btn btn-primary">New Topic</a>
  </div>

  <style>
    .forum-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .forum-header h1 {
      color: var(--secondary-color);
      font-size: 24px;
    }

    .sticky-topic {
      background-color: rgba(138, 3, 3, 0.1) !important;
    }

    .topic-sticky {
      color: var(--primary-color);
      font-weight: bold;
    }

    .topic-locked {
      color: #666;
      font-weight: bold;
    }

    .no-topics {
      background-color: var(--forum-topic-bg);
      padding: 30px;
      text-align: center;
      border: 1px solid var(--border-color);
    }

    .no-topics p {
      margin-bottom: 15px;
    }

    .forum-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
    }

    /* Topic List Styles */
    .topics-list {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--forum-topic-bg);
      border: 1px solid var(--border-color);
    }

    .topics-list th {
      background-color: var(--forum-category-bg);
      color: var(--secondary-color);
      padding: 10px;
      text-align: left;
      font-weight: bold;
      border-bottom: 1px solid var(--border-color);
    }

    .topics-list td {
      padding: 12px 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .topics-list tr:nth-child(even) {
      background-color: var(--forum-topic-alt);
    }

    .topic-title {
      width: 45%;
      font-weight: bold;
    }

    .topic-title a {
      color: var(--link-color);
      text-decoration: none;
    }

    .topic-title a:hover {
      text-decoration: underline;
    }
  </style>
</MainLayout>
